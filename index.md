# Butler Databases for Community Science Users at the RSP

```{abstract}
Describes the database infrastructure that supports end-user access to Butler metadata via the Rubin Science Platform.
```

## Scope


Not included in this document are:
* Butler databases used internally by the project team
* Butler databases hosted by other institutions (which may contain the same data as the databases described here.)
* The filesystem containing the image data ("datastore" in Butler jargon)

## Taxonomy of Butler databases

### Database access method

There are two primary methods of accessing Butler metadata, shown in the table
below.  These two access methods use two different database schemas.

| Access Method | Schema |
| ------------- | ------ |
| Butler library | Butler Registry |
| IVOA TAP service | ObsCore |

Confusingly, these two schemas sometimes co-exist in the same database and
sometimes are deployed separately.  Some considerations for how these databases
are configured for each deployment are described below.


#### Registry (supports Butler library)

The [Registry schema](https://dmtn-073.lsst.io/) supports access to Butler data
via the [Butler library](https://github.com/lsst/daf_butler) and [pipelines
framework](https://dmtn-229.lsst.io/).  It tracks the location of data files
generated by the telescope and science pipelines, along with metadata allowing
searches for files of interest.

A Registry database can be hosted using either Postgres or SQLite.  Large-scale
shared repositories are hosted using Postgres, while SQLite is used for smaller
personal repositories.

#### ObsCore (supports TAP)

ObsCore is an [IVOA standard](https://www.ivoa.net/documents/ObsCore/) defining
a set of observation metadata and a protocol for accessing it.  The metadata
for some Butler dataset types in the Registry can be presented as an ObsCore
table.

We currently have two ways to host ObsCore data derived from Butler metadata:
* Loaded into [QServ](https://dmtn-243.lsst.io/) alongside the LSST catalogs.
* Co-located in the same Postgres database as the Butler Registry, in a separate table.

In both of these cases, end users access the data via a [TAP
service](https://github.com/lsst-sqre/lsst-tap-service), [hosted in the Rubin
Science Platform](https://phalanx.lsst.io/applications/tap/index.html).

##### QServ

ObsCore via QServ is used for the annual data releases, because QServ provides
a spatially partitioned, scalable cluster of database instances.  When the data
release is made, [a script](https://github.com/lsst-dm/dax_obscore) is used to
convert metadata from the Butler Registry database into a format that can be
ingested by QServ.

QServ is not well-suited for dynamically updated data, so this setup is only
used for static data releases.

##### Co-located with Registry DB

The ObsCore table can also be hosted in Postgres, sharing a database with the
Butler Registry.  The Butler library can be configured with an ["ObsCore
Manager"](https://github.com/lsst/daf_butler/blob/50c0a9ef673d2b360f76026ea5d13829836f77b2/python/lsst/daf/butler/registry/obscore/_manager.py#L115)
that maintains an ObsCore table containing information about datasets in the
Registry.  As datasets are added through the usual Butler methods for updating
the Registry, the ObsCore table is updated simultaneously.


### Update modes

Different Butler repositories are updated at different cadences.  This affects:
* How data is loaded into the database
* How aggressively data can be cached by consumers
* Which databases can be used

Repositories may be entirely static, batch updated on a regular schedule, or
updated continuously as changes are made.

(static)=
#### Static

Data releases are generated in full prior to their release to the public, and
are not changed after they are created.  This allows flexibility in hosting
their databases, because a separate public-facing database can be created by
bulk-loading a copy of the data.

For these databases, the Registry data will be hosted in Postgres via Google
Cloud SQL at the IDF. ObsCore data will be hosted in QServ at the USDF.

Because the data is not changed after it is deployed, Butler server can
aggressively cache frequently used tables and we can deploy multiple read
replicas to scale the database load.

See [below](#dp1) for more information about this
configuration for Data Preview 1 and subsequent data releases.

(batch-update)=
#### Batch update

The prompt data products repository will be updated nightly as new data is
released from embargo.  [A script](https://github.com/lsst-dm/transfer_embargo)
copies data from the internal embargo repository to a separate public
repository.

Because the data is updated in predictable ways at predictable times, the
Butler server can still aggressively cache data as long as we invalidate the
caches after the batch update.

There are technical limitations with both available methods for hosting ObsCore that makes it difficult
to host a frequently-changing ObsCore database:
* QServ is not designed for dynamic updates, so it cannot host ObsCore for a
  changing repository.
* For spatial indexing in Postgres, the ObsCore manager uses the [pg_sphere
Postgres extension](https://github.com/postgrespro/pgsphere).  This extension
is not available in Google Cloud SQL, and it is unlikely to be supported in the
future because it has few users outside of astronomy.

Consequently, we can currently only host a batch-updated ObsCore database in a 
Postgres deployment at USDF, where we have control over the extensions
available. (We could also host a custom Postgres deployment at Google using a
virtual machine or Kubernetes, but the Butler team lacks a database
administrator to manage this setup.)

#### Online, immediate update

Internal Butler databases used by the Rubin project team are updated constantly
as new data arrives from the summit and as pipeline processing finishes.  The
Butler library is used to perform these updates.

We do not currently plan to use this update mode to serve data generated by the
Rubin project to end-users.  

However, there is a requirement that we provide hosting for end users to share
data products that they have created.  For [Data Preview 0.2](#dp02) we allow
end-users to write directly into the Registry database, with changes
immediately visible to other users.

(dimension-universes)=
### Metadata Schema ("Dimension Universe")

Each Butler repository has a "Dimension Universe" defining the metadata values
that can be stored in the database, and the relationships between those values.

This "Dimension Universe" is tightly coupled to the science pipelines that
generate the data products tracked by the Butler.  It changes over time as the
pipelines evolve. As a result, different repositories will have different
universe versions.  Data Release repositories will use the version that was
current at the time the Data Release was made, while Prompt Data Products will
usually use the newest version.

## Butler database deployments

The following diagram shows the databases that will exist in mid-2025 to
support end user access to Butler data via the Rubin Science Platform:

![System diagram](Butler-databases.drawio.png)

(dp02)=
### Data Preview 0.2
#### Summary
* Status: Deployed
* Registry: Google Cloud SQL at IDF
* ObsCore: QServ at USDF
* Update mode: Static and online user-generated

[Data Preview 0.2](https://dp0-2.lsst.io/) contains data products simulating a
portion of the LSST survey.  It is hosted on the Rubin Science Platform to
allow community science users to become familiar with LSST data products and
the tools for accessing them.

The DP0.2 Butler Registry is hosted in Postgres via Google Cloud SQL.  It
tracks approximately 250 million datasets.  The data was bulk-loaded using
Postgres's `pg_restore` utility, from a database backup generated using
`pg_dump` on the database used to process the data at the USDF.

The DP0.2 data generated by the Rubin project is static, like future data
releases.  However, users are allowed to store information about their own
user-generated products in the same Registry database containing the Data
Preview data.  There are no access controls and all changes are immediately
visible to other users.

End users can access data in the Butler Registry using the Butler library, and
there are several tutorial notebooks showing how to do this.  This Butler
Registry also backs other Rubin Science Platform services like
[vo-cutouts](https://github.com/lsst-sqre/vo-cutouts) and
[datalinker](https://github.com/lsst-sqre/datalinker/), which access it
indirectly through [Butler server](https://dmtn-283.lsst.io/).

ObsCore is hosted in QServ at the USDF, sharing a database with the catalog
portion of the Data Preview.  The data was exported from the Butler registry
using [dax_obscore](https://github.com/lsst-dm/dax_obscore) and ingested into
QServ.  This supports TAP queries through the Portal aspect, and can also be
accessed using other IVOA-standard TAP tools.

(dp1)=
### Data Preview 1
#### Summary
* Status: Planned for 2025
* Registry: Google Cloud SQL at IDF
* ObsCore: QServ at USDF
* Update mode: Static

Following the completion of data processing for [Data Preview
1](https://rtn-085.lsst.io/), a "curated" Registry database will be created at
the USDF by the Campaign Management team.  This registry contains a cleaned-up
version of the science pipelines outputs with some intermediate datasets
removed.

The public-facing version of the curated database will be hosted in Postgres
via Google Cloud SQL at the IDF. As in Data Preview 0.2, the data will be
transferred using `pg_dump` and `pg_restore` to make an independent copy of the
database.

Similar to Data Preview 0.2, ObsCore will be hosted in QServ at the USDF, using
data exported from the Registry using
[dax_obscore](https://github.com/lsst-dm/dax_obscore).

### Future data releases
#### Summary
* Status: Planned for future
* Registry: Google Cloud SQL or AlloyDB at IDF
* ObsCore: QServ at USDF
* Update mode: Static

The general pattern for future data releases will be similar to Data Preview 1:
the Registry will be hosted using Google-managed databases at IDF, and ObsCore
will be hosted in QServ at USDF.  The databases for each data release are
independent of the other data releases -- they will likely have different
[dimension universes](#dimension-universes) and thus incompatible database
schemas.

Because future data releases will be larger and have many more users, a single
node deployment of Postgres may not be sufficient to handle the load for the
Registry database. We may use multiple Postgres instances as read replicas. We
also plan to evaluate Google's [AlloyDB](https://cloud.google.com/alloydb),
which is a scalable Postgres-compatible database.

### Prompt data products
#### Summary
* Status: Planned for 2025
* Registry: Postgres at USDF
* ObsCore: In same Postgres as Registry at USDF
* Update mode: Batch (updated daily)

From the start of the survey, [prompt data products](https://lse-163.lsst.io/)
will be released daily to the community.  This will require Butler Registry and
ObsCore databases to support the same search functionality provided for the
data releases.

As data is released from [embargo](https://rtn-073.lsst.io), it is copied from
the embargo Butler repository to the public prompt data products repository
using the [`transfer_embargo` script](https://github.com/lsst-dm/transfer_embargo).

Initially, we plan to host both the Registry and ObsCore databases together in
a single Postgres database at the USDF.  As discussed [above](#batch-update),
we do not currently have a way to host ObsCore for this deployment anywhere but
the USDF.  We also do not currently have a way to maintain an ObsCore table
separate from the Registry, so it is expedient to have these databases together
at USDF.

A VPN or SSH tunnel to the services using this database at the IDF will secure
the connection to the database.

As the database grows, we may split the Registry database from the ObsCore
database and move the Registry database to IDF. This will reduce the round-trip
time for services using the Butler, and let us use the same Google database
hosting used for the data releases.  Because the ObsCore table includes
access URLs that require the Registry to resolve (via
[datalinker](https://github.com/lsst-sqre/datalinker/)), we will need to ensure
that the Registry is updated before the ObsCore table is updated.



### User-generated data
#### Summary
* Status: Part of a system that is not yet designed
* Registry: Google Cloud SQL at IDF
* ObsCore: N/A
* Update mode: Online user-generated