# Butler Databases for Community Science Users at the RSP

```{abstract}
Describes the database infrastructure that supports end-user access to Butler metadata via the Rubin Science Platform.
```

## Scope


Not included in this document are:
* Butler databases used internally by the project team
* Butler databases hosted by other institutions (which may contain the same data as the databases described here.)
* The filesystem containing the image data ("datastore" in Butler jargon)

## Taxonomy of Butler databases

### Database access method

There are two primary methods of accessing Butler metadata, shown in the table
below.  These two access methods use two different database schemas.

| Access Method | Schema |
| ------------- | ------ |
| Butler library | Butler Registry |
| IVOA TAP service | ObsCore |

Confusingly, these two schemas sometimes co-exist in the same database and
sometimes are deployed separately.  Some considerations for how these databases
are configured for each deployment are described below.


#### Registry (supports Butler library)

- postgres and sqlite
- expect to explore read replicas or AlloyDB for scalability

#### ObsCore (supports TAP)

ObsCore is an [IVOA standard](https://www.ivoa.net/documents/ObsCore/) defining
a set of observation metadata, and a protocol for accessing it.  The metadata
for some Butler dataset types in the Registry can be presented as an ObsCore
table.

We currently have two ways to host ObsCore data derived from Butler metadata:
* Loaded into [QServ](https://dmtn-243.lsst.io/) alongside the LSST catalogs.
* Co-located in the same Postgres database as the Butler Registry, in a separate table.

In both of these cases, end users access the data via a [TAP
service](https://github.com/lsst-sqre/lsst-tap-service), [hosted in the Rubin
Science Platform](https://phalanx.lsst.io/applications/tap/index.html).

##### QServ

ObsCore via QServ is used for the annual data releases, because QServ provides
a scalable cluster of database instances.  When the data release is made, [a
script](https://github.com/lsst-dm/dax_obscore) is used to convert metadata
from the Butler Registry DB into a format that can be ingested by QServ.

QServ is not well-suited for dynamically updated data, so this setup is only
used for static data releases.

##### Co-located with Registry DB

The ObsCore table can also be hosted in Postgres, sharing a database with the
Butler Registry.  The Butler library can be configured with an ["ObsCore
Manager"](https://github.com/lsst/daf_butler/blob/50c0a9ef673d2b360f76026ea5d13829836f77b2/python/lsst/daf/butler/registry/obscore/_manager.py#L115)
that maintains an ObsCore table containing information about datasets in the
Registry.  As datasets are added through the usual Butler methods for updating
the Registry, the ObsCore table is updated simultaneously.

For spatial indexing, the ObsCore table uses the [pg_sphere Postgres
extension](https://github.com/postgrespro/pgsphere).  This extension is fairly
niche, with few use cases outside of astronomy.  It is not supported by Google
Cloud SQL, making deployment at the [Rubin Science Platform on Google
Cloud](https://dmtn-209.lsst.io/) more difficult.

### Update modes

Different Butler repositories are updated at different cadences.  This affects:
* How data is loaded into the database
* How aggressively data can be cached by consumers
* Which databases can be used

#### Static

Data releases are generated in full prior to their release to the public, and
are not changed after they are created.  This allows flexibility in hosting
their databases, because a separate public-facing database can be created by
bulk-loading a copy of the data.

For these databases, the Registry data will be hosted in Postgres via Google
Cloud SQL at the IDF. ObsCore data will be hosted in QServ at the USDF.

Because the data is not changed after it is deployed, Butler server can
aggressively cache frequently used tables and we can deploy multiple read
replicas to scale the database load.

See [below](#dp1) for more information about this
configuration for Data Preview 1 and subsequent data releases.

#### Batch update

- no qserv
- no IDF for ObsCore


#### Online, immediate update

Internal Butler databases used by the Rubin project team are updated constantly
as new data arrives from the summit and as pipeline processing finishes.  The
Butler library is used to perform these updates.

We do not currently plan to use this update mode to serve data generated by the
Rubin project to end-users.  

However, there is a requirement that we provide hosting for end users to share
data products that they have created.  For [Data Preview 0.2](#dp02)
we allow end-users to write directly into the Registry database.

### Metadata Schema ("Dimension Universe")

Each Butler repository has a "Dimension Universe" defining the metadata values
that can be stored in the database, and the relationships between those values.

This "Dimension Universe" is tightly coupled to the science pipelines that
generate the data products tracked by the Butler.  It changes over time as the
pipelines evolve. As a result, different repositories will have different
universe versions.  Data Release repositories will use the version that was
current at the time the Data Release was made, while Prompt Data Products will
usually use the newest version.

## Butler database deployments

The following diagram shows the databases that will exist in mid-2025 to
support end user access to the Butler in the RSP:

![System diagram](Butler-databases.drawio.png)


(dp02)=
### Data Preview 0.2
#### Summary
* Status: Deployed
* Registry: Google Cloud SQL at IDF
* ObsCore: Separate database (QServ)
* Update mode: Static and online user-generated




(dp1)=
### Data Preview 1 and Data Releases
#### Summary
* Status: Planned for 2025
* Registry: Google Cloud SQL at IDF
* ObsCore: Separate database (QServ)
* Update mode: Static

 A "curated" Registry database will be created at the USDF by the Campaign
 Management team.  This registry contains a cleaned-up version of the science
 pipelines outputs with some intermediate datasets removed.

The public-facing version of the curated database is hosted in Google Cloud SQL at the IDF.  It is
created by 

### Prompt data products
#### Summary
* Status: Planned for 2025
* Registry: Postgres at USDF
* ObsCore: In same Postgres as registry at USDF
* Update mode: Batch (updated daily)

### User-generated data
#### Summary
* Status: Part of a system that is not yet designed
* Registry: Google Cloud SQL at IDF
* ObsCore: N/A
* Update mode: Online user-generated